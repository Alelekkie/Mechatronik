<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>System Urlopowy - Firebase</title>
<style>
body,html{margin:0;padding:0;font-family:Arial,sans-serif;background:#f5f5f5;}
.container{max-width:900px;margin:auto;padding:10px;}
#loginDiv,#adminDiv,#employeeDiv{display:flex;flex-direction:column;align-items:center;padding:20px;border-radius:10px;margin-top:20px;box-shadow:0 5px 15px rgba(0,0,0,0.2);}
#adminDiv,#employeeDiv{display:none;min-height:80vh;width:90%;color:white;}
#adminDiv{background:black;}
#employeeDiv{background:#222;}
input,select{padding:10px;margin:5px 0;width:90%;max-width:250px;border-radius:5px;border:1px solid #aaa;}
button{padding:10px;margin-top:10px;width:90%;max-width:270px;border:none;border-radius:5px;background:#007bff;color:white;cursor:pointer;}
button:hover{background:#0056b3;}
#errorMsg{color:red;font-weight:bold;margin-top:5px;}
#calendarControls{display:flex;justify-content:space-between;width:100%;max-width:300px;margin-top:10px;}
#calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-top:10px;width:100%;}
.day{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid #888;background:#222;}
.selected{background:lightgreen;}
table{border-collapse:collapse;width:100%;margin-top:10px;color:white;}
table,th,td{border:1px solid white;padding:5px;text-align:center;}
.approved{background:green !important;}
.rejected{background:red !important;}
#logoutBtn{margin-top:20px;width:150px;background:#ff4d4d;color:white;}
#logoutBtn:hover{background:#cc0000;}
@media(max-width:500px){input,select,button{width:100%;} #calendar{grid-template-columns:repeat(7,1fr);}}
</style>
</head>
<body>
<div class="container">
  <!-- LOGIN -->
  <div id="loginDiv">
    <h2>Logowanie</h2>
    <input type="text" id="email" placeholder="Imię">
    <input type="password" id="password" placeholder="Hasło">
    <button onclick="login()">Zaloguj</button>
    <button onclick="togglePassword()">Pokaż/Ukryj hasło</button>
    <div id="errorMsg"></div>
  </div>

  <!-- ADMIN -->
  <div id="adminDiv">
    <h2>ADMIN</h2>
    <h3>Przypisz dni urlopowe:</h3>
    <select id="employeeSelect"></select>
    <input type="number" id="taskDays" placeholder="Dni zadaniowe">
    <input type="number" id="vacationDays" placeholder="Dni wypoczynkowe">
    <button onclick="setEmployeeDays()">Zapisz</button>

    <h3>Wnioski urlopowe:</h3>
    <table id="adminTable">
      <tr><th>Pracownik</th><th>Dni</th><th>Typ</th><th>Status</th><th>Akcja</th></tr>
    </table>
    <button id="logoutBtn" onclick="logout()">Wyloguj</button>
  </div>

  <!-- PRACOWNIK -->
  <div id="employeeDiv">
    <h2>PRACOWNIK</h2>
    <div>Twoje dni: <span id="remainingTaskDays">0</span> zadaniowe, <span id="remainingVacationDays">0</span> wypoczynkowe</div>
    <div id="calendarControls">
      <button onclick="changeMonth(-1)">&lt; Poprzedni</button>
      <span id="monthLabel"></span>
      <button onclick="changeMonth(1)">Następny &gt;</button>
    </div>
    <select id="leaveType">
      <option value="zadaniowy">Zadaniowy</option>
      <option value="wypoczynkowy">Wypoczynkowy</option>
    </select>
    <div id="calendar"></div>
    <button onclick="sendVacation()">Wyślij wniosek</button>

    <h3>Twoje wnioski:</h3>
    <table id="employeeTable">
      <tr><th>Dni</th><th>Typ</th><th>Status</th></tr>
    </table>
    <button id="logoutBtn" onclick="logout()">Wyloguj</button>
  </div>
</div>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const users=[
  {email:"pawel", password:"0909", role:"admin"},
  {email:"justyna", password:"1234", role:"employee"},
  {email:"klaudia", password:"5678", role:"employee"}
];

let currentUser=null, selectedDays=[], currentMonth=new Date().getMonth(), currentYear=new Date().getFullYear();
const monthNames=["Styczeń","Luty","Marzec","Kwiecień","Maj","Czerwiec","Lipiec","Sierpień","Wrzesień","Październik","Listopad","Grudzień"];

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD3XXnIM1gTcfMTj63lgyo8lUuivjPBO-I",
  authDomain: "urlopy-ee985.firebaseapp.com",
  projectId: "urlopy-ee985",
  storageBucket: "urlopy-ee985.firebasestorage.app",
  messagingSenderId: "1054650388220",
  appId: "1:1054650388220:web:3545e54d9305db91e49179",
  measurementId: "G-S3KDP408JF"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Initialize employees in Firebase if not exists
async function initEmployees() {
  for (let u of users.filter(u=>u.role==="employee")) {
    const doc = await db.collection("employees").doc(u.email).get();
    if(!doc.exists) {
      await db.collection("employees").doc(u.email).set({task:5, vacation:15});
    }
  }
}
initEmployees();

function togglePassword(){
  const pass=document.getElementById("password");
  pass.type=pass.type==="password"?"text":"password";
}

async function login(){
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();
  const errorMsg=document.getElementById("errorMsg");
  errorMsg.innerText="";
  if(!email||!password){ errorMsg.innerText="Wpisz login i hasło!"; return; }
  const user=users.find(u=>u.email===email && u.password===password);
  if(user){
    currentUser=user;
    document.getElementById("loginDiv").style.display="none";
    if(user.role==="admin"){
      document.getElementById("adminDiv").style.display="flex";
      loadEmployeeOptions(); loadAdminRequests();
    } else {
      document.getElementById("employeeDiv").style.display="flex";
      await loadEmployeeDays(); buildCalendar(); loadEmployeeRequests();
    }
  } else errorMsg.innerText="Błędne dane logowania!";
}

function logout(){
  currentUser=null; selectedDays=[];
  document.getElementById("loginDiv").style.display="flex";
  document.getElementById("adminDiv").style.display="none";
  document.getElementById("employeeDiv").style.display="none";
  document.getElementById("password").value="";
  document.getElementById("errorMsg").innerText="";
}

// --- Admin ---
async function loadEmployeeOptions(){
  const select=document.getElementById("employeeSelect");
  select.innerHTML="";
  const snapshot = await db.collection("employees").get();
  snapshot.forEach(doc=>{
    const opt=document.createElement("option");
    opt.value=doc.id; opt.innerText=doc.id;
    select.appendChild(opt);
  });
}

async function setEmployeeDays(){
  const email=document.getElementById("employeeSelect").value;
  const taskDays=parseInt(document.getElementById("taskDays").value)||0;
  const vacDays=parseInt(document.getElementById("vacationDays").value)||0;
  await db.collection("employees").doc(email).set({task:taskDays, vacation:vacDays});
  alert("Zapisano dni dla "+email);
  loadEmployeeOptions();
}

async function loadAdminRequests(){
  const table=document.getElementById("adminTable");
  table.innerHTML="<tr><th>Pracownik</th><th>Dni</th><th>Typ</th><th>Status</th><th>Akcja</th></tr>";
  const snapshot = await db.collection("vacationRequests").get();
  snapshot.forEach(doc=>{
    const r = doc.data();
    const row=table.insertRow();
    row.insertCell(0).innerText=r.user;
    row.insertCell(1).innerText=r.days.join(", ");
    row.insertCell(2).innerText=r.type;
    row.insertCell(3).innerText=r.status;
    if(r.status==="zatwierdzony") row.classList.add("approved");
    if(r.status==="odrzucony") row.classList.add("rejected");
    const cell=row.insertCell(4);
    const btnApp=document.createElement("button"); btnApp.innerText="Zatwierdź"; 
    btnApp.onclick=async ()=>{
      await db.collection("vacationRequests").doc(doc.id).update({status:"zatwierdzony"});
      loadAdminRequests();
    };
    const btnRej=document.createElement("button"); btnRej.innerText="Odrzuć"; btnRej.style.marginLeft="5px"; 
    btnRej.onclick=async ()=>{
      await db.collection("vacationRequests").doc(doc.id).update({status:"odrzucony"});
      loadAdminRequests();
    };
    cell.appendChild(btnApp); cell.appendChild(btnRej);
  });
}

// --- Employee ---
async function loadEmployeeDays(){
  const doc = await db.collection("employees").doc(currentUser.email).get();
  const days = doc.data();
  document.getElementById("remainingTaskDays").innerText=days.task;
  document.getElementById("remainingVacationDays").innerText=days.vacation;
  return days;
}

function buildCalendar(){
  const cal=document.getElementById("calendar");
  cal.innerHTML="";
  const daysInMonth=new Date(currentYear,currentMonth+1,0).getDate();
  document.getElementById("monthLabel").innerText=monthNames[currentMonth]+" "+currentYear;
  for(let i=1;i<=daysInMonth;i++){
    const day=document.createElement("div"); day.className="day"; day.innerText=i;
    day.onclick=()=>{ 
      if(selectedDays.includes(i)){ selectedDays=selectedDays.filter(d=>d!==i); day.classList.remove("selected"); }
      else{ selectedDays.push(i); day.classList.add("selected"); }
    };
    cal.appendChild(day);
  }
}

function changeMonth(delta){
  currentMonth+=delta;
  if(currentMonth<0){currentMonth=11; currentYear--;}
  else if(currentMonth>11){currentMonth=0; currentYear++;}
  buildCalendar();
}

async function sendVacation(){
  if(selectedDays.length===0){alert("Zaznacz dni!"); return;}
  const type=document.getElementById("leaveType").value;
  const daysData = await db.collection("employees").doc(currentUser.email).get();
  const days = daysData.data();
  if(type==="zadaniowy" && selectedDays.length>days.task){alert("Brak wystarczającej liczby dni zadaniowych!"); return;}
  if(type==="wypoczynkowy" && selectedDays.length>days.vacation){alert("Brak wystarczającej liczby dni wypoczynkowych!"); return;}
  if(type==="zadaniowy") days.task-=selectedDays.length;
  else days.vacation-=selectedDays.length;
  await db.collection("employees").doc(currentUser.email).set(days);

  const newDoc = await db.collection("vacationRequests").add({
    user: currentUser.email,
    month: currentMonth,
    year: currentYear,
    days: selectedDays,
    type: type,
    status: "oczekuje"
  });
  selectedDays=[];
  buildCalendar();
  await loadEmployeeRequests();
}

async function loadEmployeeRequests(){
  const table=document.getElementById("employeeTable");
  table.innerHTML="<tr><th>Dni</th><th>Typ</th><th>Status</th></tr>";
  const snapshot = await db.collection("vacationRequests").where("user","==",currentUser.email).get();
  snapshot.forEach(doc=>{
    const r=doc.data();
    const row=table.insertRow();
    row.insertCell(0).innerText=`${monthNames[r.month]} ${r.days.join(", ")}`;
    row.insertCell(1).innerText=r.type;
    row.insertCell(2).innerText=r.status;
    if(r.status==="zatwierdzony") row.classList.add("approved");
    if(r.status==="odrzucony") row.classList.add("rejected");
  });
}
</script>
</body>
</html>
